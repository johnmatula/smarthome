var timeout,requests=!1,weatherapikey=!1,controlOutlets=function(t,e){$.ajaxQueue({url:"php/status.php",data:{action:t.attr("data-actiontype"),turnoff:e,outlets:t.attr("data-outlets").split(",")}}).done(function(t){requests&&requests.abort(),queryOutletStatus()})},updateWeatherFirstTime=function(){$.ajax({url:"php/apikey.php",success:function(t){weatherapikey=t,updateWeather()},timeout:1e3,error:function(t,e,a){console.warn("Status JSON returned error: "+a)}})},queryOutletStatus=function(){requests=$.ajax({url:"php/status.json?nocache="+(new Date).getTime(),success:function(t){updateUI(t)},timeout:1750,error:function(t,e,a){console.warn("Status JSON returned error: "+a)}})},updateUI=function(e){Object.keys(e.outlets).forEach(function(t){$("button[data-outlets="+t+"]").attr("data-status",e.outlets[t]?"on":"off")}),Object.keys(e.rooms).forEach(function(t){$(".room[data-outlets="+t+"]").attr("data-status",e.rooms[t]?"on":"off")})},refreshClock=function(){$(".clock__time").html(moment().format("h:mm")),$(".clock__weekday").html(moment().format("dddd")),$(".clock__date").html(moment().format("D MMMM"))},updateWeather=function(){$.ajax({url:"https://api.openweathermap.org/data/2.5/weather?lat=40.780366&lon=-73.948188&appid="+weatherapikey+"&units=imperial",success:function(t){$(".weather__temp").text(Math.round(t.main.temp)+"°"),$(".weather__humidity").text("Humidity "+Math.round(t.main.humidity)+"%");var e=calculateFeels(t.main.temp,t.main.humidity,t.wind.speed);e?$(".weather__feels").text("Feels like "+Math.round(e)+"°"):$(".weather__feels").text(),.5<=t.wind.speed?$(".weather__wind").text("Wind "+Math.round(t.wind.speed)).append(" <span class='weather__windunit'>MPH</span>"):$(".weather__wind").text("Wind is calm")},timeout:3e3,error:function(t,e,a){console.warn("Weather returned error: "+a)}})};function calculateFeels(t,e,a){var r=!1;return 75<=t?(r=calculateHeatIndex(t,e))<=t&&(r=!1):t<=55&&3<=a&&t<=(r=calculateWindChill(t,a))&&(r=!1),r}function calculateHeatIndex(t,e){if(((a=.5*(t+61+1.2*(t-68)+.094*e))+t)/2<80)return t;var a=2.04901523*t-42.379+10.14333127*e-.22475541*t*e-.00683783*t*t-.05481717*e*e+.00122874*t*t*e+85282e-8*t*e*e-199e-8*t*t*e*e;return 80<=t&&t<=112&&e<13?a-=(13-e)/4*Math.sqrt((17-Math.abs(t-95))/17):80<=t&&t<=87&&85<e&&(a+=(e-85)/10*((87-t)/5)),Math.round(a)}function calculateWindChill(t,e){return Math.round(35.74+.6215*t-35.75*Math.pow(e,.16)+.4275*t*Math.pow(e,.16))}$(function(){$("button[data-actiontype], .room").longpress(function(){controlOutlets($(this),"off")},function(){controlOutlets($(this),"")},500),$(".clock__weekday").longpress(function(){window.location.reload()},function(){},100),FastClick.attach(document.body),queryOutletStatus();setInterval(queryOutletStatus,2e3);refreshClock();setInterval(refreshClock,2500);updateWeatherFirstTime();setInterval(updateWeather,3e5)}),function(s){var c=s({});s.ajaxQueue=function(r){function n(t){o=s.ajax(r).done(u.resolve).fail(u.reject).then(t,t)}var o,u=s.Deferred(),i=u.promise();return c.queue(n),i.abort=function(t){if(o)return o.abort(t);var e=c.queue(),a=s.inArray(n,e);return-1<a&&e.splice(a,1),u.rejectWith(r.context||r,[i,t,""]),i},i}}(jQuery);